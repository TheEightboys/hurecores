rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isOrgMember(orgId) {
      let user = getUserData();
      return isAuthenticated() && user.organizationId == orgId && user.staffStatus == 'Active';
    }
    
    function isOrgAdmin(orgId) {
      let user = getUserData();
      return isOrgMember(orgId) && (user.systemRole == 'OWNER' || user.systemRole == 'ADMIN');
    }
    
    function isSuperAdmin() {
      // In a real app, you might have a custom claim or a specific user list
      // For now, checking if user has a specific 'SUPER_ADMIN' role in their profile
      let user = getUserData();
      return isAuthenticated() && user.systemRole == 'SUPER_ADMIN'; 
    }

    // ========================================================
    // Top-Level Collections
    // ========================================================

    // User Profiles
    match /users/{userId} {
      // Users can read/write their own profile
      allow read, write: if isUser(userId);
      // Org members can read other members' profiles (for directory, etc)
      allow read: if isAuthenticated() && 
                  resource.data.organizationId == getUserData().organizationId;
    }

    // Organizations
    match /organizations/{orgId} {
      // Create: Allow any authenticated user to create an organization (onboarding)
      allow create: if isAuthenticated();
      // Read: Org members
      allow read: if isOrgMember(orgId);
      // Update: Org admins
      allow update: if isOrgAdmin(orgId);
      
      // ======================================================
      // Subcollections
      // ======================================================
      
      // Staff
      match /staff/{staffId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgAdmin(orgId);
      }
      
      // Locations
      match /locations/{locationId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgAdmin(orgId);
      }
      
      // Shifts & Assignments
      match /shifts/{shiftId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgAdmin(orgId);
      }
      match /shiftAssignments/{assignId} {
        allow read: if isOrgMember(orgId);
        // Admins can write, Staff can update status (accept/decline)
        allow write: if isOrgAdmin(orgId) || (isOrgMember(orgId) && request.resource.data.staffId == request.auth.uid);
      }
      
      // Attendance
      match /attendance/{recordId} {
        // Staff can read their own, Admins can read all
        allow read: if isOrgAdmin(orgId) || (isOrgMember(orgId) && resource.data.staffId == request.auth.uid);
        // Staff can clock in/out (create/update their own)
        allow create: if isOrgMember(orgId) && request.resource.data.staffId == request.auth.uid;
        allow update: if isOrgMember(orgId) && resource.data.staffId == request.auth.uid;
        // Admins can manage all
        allow write: if isOrgAdmin(orgId);
      }
      
      // Leave Requests
      match /leaveRequests/{requestId} {
        allow read: if isOrgAdmin(orgId) || (isOrgMember(orgId) && resource.data.staffId == request.auth.uid);
        allow create: if isOrgMember(orgId) && request.resource.data.staffId == request.auth.uid;
        // Staff can cancel (update status) if pending
        allow update: if isOrgAdmin(orgId) || 
                     (isOrgMember(orgId) && resource.data.staffId == request.auth.uid && resource.data.status == 'Pending');
      }
      
      match /leaveBalances/{balanceId} {
        allow read: if isOrgMember(orgId); // Staff need to see balances
        allow write: if isOrgAdmin(orgId); // Only admins adjust balances
      }
       match /leaveTypes/{typeId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgAdmin(orgId);
      }
      
      // Payroll
      match /payrollPeriods/{periodId} {
        allow read, write: if isOrgAdmin(orgId);
      }
      match /payrollEntries/{entryId} {
         allow read: if isOrgAdmin(orgId) || (isOrgMember(orgId) && resource.data.staffId == request.auth.uid);
         allow write: if isOrgAdmin(orgId);
      }
      
      // Documents
       match /documents/{docId} {
        allow read: if isOrgMember(orgId);
        allow write: if isOrgAdmin(orgId);
      }
      
       // Subscriptions
       match /subscriptions/{subId} {
        allow read: if isOrgAdmin(orgId);
        allow write: if false; // Handled by backend/webhook usually
      }
      
       // Notifications
       match /notifications/{notifId} {
        allow read: if isOrgMember(orgId) && resource.data.userId == request.auth.uid;
        allow write: if isOrgAdmin(orgId); // Or system
      }
    }

    // Verification Requests (Platform Level)
    match /verificationRequests/{requestId} {
      allow create: if isAuthenticated();
      // Only the requester or platform admins can read
      allow read: if isAuthenticated() && (resource.data.submittedBy == request.auth.uid || isSuperAdmin());
      // Only platform admins can update status
      allow update: if isSuperAdmin();
    }
    
    // Audit Logs
    match /auditLogs/{logId} {
      // Append-only for everyone? Or unrestricted for now as we don't have server-side
      allow create: if isAuthenticated();
      allow read: if isSuperAdmin() || (isAuthenticated() && resource.data.organizationId == getUserData().organizationId);
      allow update, delete: if false; 
    }
  }
}
